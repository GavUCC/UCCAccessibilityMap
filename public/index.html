<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>OSM + Leaflet Quickstart</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: system-ui, sans-serif;
      }
      #map {
        height: 100%;
      }

      .control-panel {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
        background: white;
        padding: 16px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        max-width: 300px;
      }

      .control-panel h3 {
        margin: 0 0 12px 0;
        font-size: 16px;
      }

      .instructions {
        font-size: 13px;
        color: #555;
        margin-bottom: 12px;
        line-height: 1.4;
      }

      .point-display {
        font-size: 12px;
        margin: 8px 0;
        padding: 8px;
        background: #f5f5f5;
        border-radius: 4px;
      }

      .point-display.active {
        background: #e3f2fd;
        border-left: 3px solid #2196f3;
      }

      .point-label {
        font-weight: 600;
        color: #333;
      }

      .point-coords {
        color: #666;
        font-family: monospace;
        font-size: 11px;
      }

      button {
        padding: 8px 16px;
        margin: 4px 4px 4px 0;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
      }

      .btn-primary {
        background: #2196f3;
        color: white;
      }

      .btn-primary:hover {
        background: #1976d2;
      }

      .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: #eee;
        color: #333;
      }

      .btn-secondary:hover {
        background: #ddd;
      }

      .route-info {
        margin-top: 12px;
        padding: 12px;
        background: #e8f5e9;
        border-radius: 4px;
        font-size: 13px;
        display: none;
      }

      .route-info.visible {
        display: block;
      }

      .route-stat {
        display: flex;
        justify-content: space-between;
        margin: 4px 0;
      }

      .route-stat-label {
        color: #555;
      }

      .route-stat-value {
        font-weight: 600;
      }

      .status-message {
        font-size: 12px;
        padding: 8px;
        border-radius: 4px;
        margin-top: 8px;
        display: none;
      }

      .status-message.error {
        display: block;
        background: #ffebee;
        color: #c62828;
      }

      .status-message.loading {
        display: block;
        background: #fff3e0;
        color: #e65100;
      }

      .start-marker {
        background: #4caf50;
        border: 2px solid white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      }

      .end-marker {
        background: #f44336;
        border: 2px solid white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      }
    </style>
  </head>
  <body>
    <div class="control-panel">
      <h3>Accessibility Router</h3>
      <div class="instructions">
        Click on the map to set your <strong>start</strong> point, then click
        again to set your <strong>end</strong> point.
      </div>

      <div id="startPoint" class="point-display active">
        <span class="point-label">Start:</span>
        <span class="point-coords" id="startCoords">Click map to set</span>
      </div>

      <div id="endPoint" class="point-display">
        <span class="point-label">End:</span>
        <span class="point-coords" id="endCoords">Click map to set</span>
      </div>

      <div>
        <button id="routeBtn" class="btn-primary" disabled>Get Route</button>
        <button id="clearBtn" class="btn-secondary">Clear</button>
      </div>

      <div id="statusMessage" class="status-message"></div>

      <div id="routeInfo" class="route-info">
        <div class="route-stat">
          <span class="route-stat-label">Distance:</span>
          <span class="route-stat-value" id="routeDistance">-</span>
        </div>
        <div class="route-stat">
          <span class="route-stat-label">Est. time:</span>
          <span class="route-stat-value" id="routeTime">-</span>
        </div>
        <div class="route-stat">
          <span class="route-stat-label">Accessibility:</span>
          <span class="route-stat-value" id="routeAccessibility">-</span>
        </div>
      </div>
    </div>
    <div id="map"></div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script>
      // 1) Init map (centered on UCC)
      const UCC_CENTER = [51.893, -8.492];
      const map = L.map("map").setView(UCC_CENTER, 17);

      // 2) Basemap tiles: Use a provider meant for apps (replace with your provider URL + key)
      // Example: https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png (community), light usage only.
      // Prefer a commercial/hosted tile service for production.
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

// State variables for routing
      let startPoint = null;
      let endPoint = null;
      let startMarker = null;
      let endMarker = null;
      let routeLayer = null;

      // Load building data
      async function loadBuildings() {
        const res = await fetch('/assets/buildings.geojson');
        const geojson = await res.json();

        L.geoJSON(geojson, {
          style: {
            color: '#0057b8',
            weight: 2,
            fillOpacity: 0.4
          },
          onEachFeature: (feature, layer) => {
            const p = feature.properties;

            const floorsHtml = (p.floors || [])
              .map(
                (img, i) =>
                  `<div>
                     <strong>Floor ${i + 1}</strong><br/>
                     <img src="${img}" style="width:200px; margin-top:4px;" />
                   </div>`
              )
              .join('<hr/>');

            const popupHtml = `
              <h3>${p.name}</h3>
              <p><strong>Opening hours:</strong><br/>${p.opening_hours}</p>
              ${floorsHtml}
            `;

            layer.bindPopup(popupHtml);
          }
        }).addTo(map);
      }

      loadBuildings();

      const startIcon = L.divIcon({
        className: "start-marker",
        iconSize: [16, 16],
        iconAnchor: [8, 8],
      });

      const endIcon = L.divIcon({
        className: "end-marker",
        iconSize: [16, 16],
        iconAnchor: [8, 8],
      });
      function updateUI() {
        const startCoords = document.getElementById("startCoords");
        const endCoords = document.getElementById("endCoords");
        const startDiv = document.getElementById("startPoint");
        const endDiv = document.getElementById("endPoint");
        const routeBtn = document.getElementById("routeBtn");

        if (startPoint) {
          startCoords.textContent = `${startPoint.lat.toFixed(
            5
          )}, ${startPoint.lng.toFixed(5)}`;
        } else {
          startCoords.textContent = "Click map to set";
        }

        if (endPoint) {
          endCoords.textContent = `${endPoint.lat.toFixed(
            5
          )}, ${endPoint.lng.toFixed(5)}`;
        } else {
          endCoords.textContent = "Click map to set";
        }

        // Highlight which point we're selecting next
        if (!startPoint) {
          startDiv.classList.add("active");
          endDiv.classList.remove("active");
        } else if (!endPoint) {
          startDiv.classList.remove("active");
          endDiv.classList.add("active");
        } else {
          startDiv.classList.remove("active");
          endDiv.classList.remove("active");
        }

        routeBtn.disabled = !(startPoint && endPoint);
      }

      function showStatus(message, type = "loading") {
        const statusEl = document.getElementById("statusMessage");
        statusEl.textContent = message;
        statusEl.className = `status-message ${type}`;
      }

      function clearStatus() {
        const statusEl = document.getElementById("statusMessage");
        statusEl.className = "status-message";
        statusEl.textContent = "";
      }

      function showRouteInfo(distance, duration) {
        document.getElementById("routeDistance").textContent =
          formatDistance(distance);
        document.getElementById("routeTime").textContent =
          formatDuration(duration);
        document.getElementById("routeAccessibility").textContent =
          "Unknown (no data yet)";
        document.getElementById("routeInfo").classList.add("visible");
      }

      function hideRouteInfo() {
        document.getElementById("routeInfo").classList.remove("visible");
      }

      function formatDistance(meters) {
        if (meters < 1000) {
          return `${Math.round(meters)} m`;
        }
        return `${(meters / 1000).toFixed(2)} km`;
      }

      function formatDuration(seconds) {
        const mins = Math.round(seconds / 60);
        if (mins < 60) {
          return `${mins} min`;
        }
        const hours = Math.floor(mins / 60);
        const remainingMins = mins % 60;
        return `${hours}h ${remainingMins}m`;
      }

      map.on("click", (e) => {
        const latlng = e.latlng;

        if (!startPoint) {
          startPoint = latlng;
          if (startMarker) map.removeLayer(startMarker);
          startMarker = L.marker(latlng, { icon: startIcon })
            .addTo(map)
            .bindPopup("Start point");
        } else if (!endPoint) {
          endPoint = latlng;
          if (endMarker) map.removeLayer(endMarker);
          endMarker = L.marker(latlng, { icon: endIcon })
            .addTo(map)
            .bindPopup("End point");
        } else {
          // Both set - reset and start over
          startPoint = latlng;
          endPoint = null;

          if (startMarker) map.removeLayer(startMarker);
          if (endMarker) map.removeLayer(endMarker);
          if (routeLayer) map.removeLayer(routeLayer);

          startMarker = L.marker(latlng, { icon: startIcon })
            .addTo(map)
            .bindPopup("Start point");
          endMarker = null;
          routeLayer = null;

          hideRouteInfo();
        }

        updateUI();
        clearStatus();
      });

      async function getRoute(start, end) {
        const url = `https://router.project-osrm.org/route/v1/foot/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson&steps=true`;

        const response = await fetch(url);

        if (!response.ok) {
          throw new Error(`Routing failed: ${response.status}`);
        }

        const data = await response.json();

        if (data.code !== "Ok" || !data.routes || data.routes.length === 0) {
          throw new Error("No route found");
        }

        return data.routes[0];
      }

      async function calculateAndDisplayRoute() {
        if (!startPoint || !endPoint) return;

        showStatus("Calculating route...", "loading");

        try {
          const route = await getRoute(startPoint, endPoint);

          if (routeLayer) map.removeLayer(routeLayer);

          routeLayer = L.geoJSON(route.geometry, {
            style: {
              color: "#2196F3",
              weight: 5,
              opacity: 0.8,
            },
          }).addTo(map);

          map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });

          showRouteInfo(route.distance, route.duration);
          clearStatus();
        } catch (error) {
          console.error("Routing error:", error);
          showStatus(`Error: ${error.message}`, "error");
        }
      }

      document.getElementById("routeBtn").onclick = calculateAndDisplayRoute;

      document.getElementById("clearBtn").onclick = () => {
        startPoint = null;
        endPoint = null;

        if (startMarker) map.removeLayer(startMarker);
        if (endMarker) map.removeLayer(endMarker);
        if (routeLayer) map.removeLayer(routeLayer);

        startMarker = null;
        endMarker = null;
        routeLayer = null;

        hideRouteInfo();
        clearStatus();
        updateUI();

        map.setView(UCC_CENTER, 17);
      };

      // Initialize
      updateUI();
    </script>
  </body>
</html>
